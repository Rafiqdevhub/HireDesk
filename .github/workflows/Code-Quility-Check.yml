name: Code Quality & Validation

on:
  pull_request:
    branches:
      - main
      - master
      - develop
    types:
      - opened
      - synchronize
      - reopened
  push:
    branches:
      - main
      - master
      - develop

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write
  pull-requests: write
  statuses: write

jobs:
  quality-checks:
    name: Code Quality & Validation
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: TypeScript Type Checking
        run: npm run typecheck
        continue-on-error: false

      - name: Build Project
        run: npm run build
        continue-on-error: false
        env:
          NODE_ENV: production

      - name: Run Unit Tests
        run: npm run test:run
        continue-on-error: false

      - name: Generate Test Coverage Report
        run: npm run test:coverage
        continue-on-error: true

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          verbose: true

      - name: Comment PR with Coverage Summary
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const coverageExists = fs.existsSync('./coverage/coverage-summary.json');

            if (coverageExists) {
              try {
                const coverage = JSON.parse(fs.readFileSync('./coverage/coverage-summary.json', 'utf8'));
                const total = coverage.total;
                
                const comment = `## Test Coverage Summary\n\n| Metric | Coverage |\n|--------|----------|\n| Statements | ${total.statements.pct}% |\n| Branches | ${total.branches.pct}% |\n| Functions | ${total.functions.pct}% |\n| Lines | ${total.lines.pct}% |\n\n‚úÖ Test suite completed successfully!`;

                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
              } catch (error) {
                console.log('Unable to parse coverage report:', error.message);
              }
            } else {
              console.log('Coverage report not found');
            }

      - name: Check for Common Security Issues
        run: |
          echo "Checking for hardcoded secrets..."
          ! grep -r "password\|api_key\|secret\|token" app/ --include="*.ts" --include="*.tsx" | grep -v "node_modules" | grep -v ".test" | grep -iE "(password|api_key|secret|token)\s*[:=]\s*['\"]" || true

      - name: Verify File Structure
        run: |
          echo "Verifying project structure..."
          test -d "app" && echo "‚úì app directory exists"
          test -f "package.json" && echo "‚úì package.json exists"
          test -f "tsconfig.json" && echo "‚úì tsconfig.json exists"
          test -f "vite.config.ts" && echo "‚úì vite.config.ts exists"
          test -d "__tests__" && echo "‚úì __tests__ directory exists"

  lint-and-format:
    name: Lint & Code Style
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install Dependencies
        run: npm ci --prefer-offline

      - name: Check for Unused Dependencies
        run: |
          echo "Checking for unused imports in TypeScript files..."
          # Simple check for common unused imports patterns
          ! grep -r "^import\|^export" app/ --include="*.ts" --include="*.tsx" | head -20 || true

      - name: Verify Package.json Integrity
        run: |
          echo "Validating package.json..."
          node -e "require('./package.json')" && echo "‚úì package.json is valid JSON"

      - name: Check for Console Logs
        run: |
          echo "Scanning for debug console statements..."
          CONSOLE_COUNT=$(grep -r "console\.log\|console\.warn\|console\.error\|debugger" app/ --include="*.ts" --include="*.tsx" 2>/dev/null | grep -v "node_modules" | wc -l || echo "0")
          if [ "$CONSOLE_COUNT" -gt 0 ]; then
            echo "‚ö†Ô∏è  Found $CONSOLE_COUNT potential debug statements"
            grep -r "console\.log\|console\.warn\|console\.error\|debugger" app/ --include="*.ts" --include="*.tsx" 2>/dev/null | grep -v "node_modules" || true
          fi

  dependencies:
    name: Dependency Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Audit Dependencies
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Check for Outdated Packages
        run: npm outdated || true

      - name: Validate Lock File
        run: npm ci --dry-run

  docker:
    name: Docker Build Validation
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Validate Dockerfile
        run: |
          echo "Validating Dockerfile..."
          docker run --rm -i hadolint/hadolint < Dockerfile || true

      - name: Build Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    timeout-minutes: 5

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Validate PR Title
        uses: amannn/action-semantic-pull-request@v5.4.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            chore
            ci
          requireScope: false

      - name: Check File Changes
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            console.log(`PR Title: ${pr.title}`);
            console.log(`Files Changed: ${files.length}`);
            console.log('\nChanged Files:');
            files.forEach(file => {
              console.log(`  ${file.status.toUpperCase()}: ${file.filename}`);
            });

            // Check for large changesets
            if (files.length > 50) {
              console.warn('‚ö†Ô∏è  Large changeset detected (>50 files)');
            }

  summary:
    name: Quality Check Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [quality-checks, lint-and-format, dependencies, docker]
    timeout-minutes: 5

    steps:
      - name: Check Quality Gate Status
        run: |
          echo "## Code Quality Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          QUALITY_STATUS="${{ needs.quality-checks.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}"
          LINT_STATUS="${{ needs.lint-and-format.result == 'success' && '‚úÖ Passed' || '‚ö†Ô∏è Warnings' }}"
          DEPS_STATUS="${{ needs.dependencies.result == 'success' && '‚úÖ Passed' || '‚ö†Ô∏è Warnings' }}"
          DOCKER_STATUS="${{ needs.docker.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}"

          echo "| Type Checking | $QUALITY_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | $QUALITY_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Validation | $QUALITY_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint & Code Style | $LINT_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Audit | $DEPS_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | $DOCKER_STATUS |" >> $GITHUB_STEP_SUMMARY

      - name: Determine Workflow Status
        if: |
          needs.quality-checks.result == 'failure' ||
          needs.lint-and-format.result == 'failure' ||
          needs.docker.result == 'failure'
        run: |
          echo "‚ùå Quality checks failed. Please review the logs above."
          exit 1

      - name: Success Summary
        if: |
          needs.quality-checks.result == 'success' &&
          needs.lint-and-format.result == 'success' &&
          needs.docker.result == 'success'
        run: |
          echo "üéâ All quality checks passed successfully!"
